<!DOCTYPE html>
<html>
<head>
    <title>Chat/{{group_name}}</title>
</head>
<body>
    <h1>Group Name : {{ group_name }}</h1>
    <textarea id="chat-log" cols="100" rows="20" disabled>
        {% for chat in chats %}
            {{chat.content}} -> {{chat.timestamp}}
        {% endfor %}
    </textarea><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send">
    {{ group_name|json_script:"group_name" }}

    <script>
        const GroupName = JSON.parse(document.getElementById('group_name').textContent)
        // Function to initialize WebSocket connection
        console.log(GroupName)
        function initWebSocket() {
            const chatSocket = new WebSocket(
                'ws://' + "127.0.0.1:8000" + '/ws/ac/' + GroupName + "/"
            );

            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established.');
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log(typeof(data))
                console.log('e.data  ',(data))
                console.log('user',(data.user))
                document.querySelector('#chat-log').value += ("@" + data.user + " : " +data.message + '\n');
            };

            chatSocket.onclose = function(e) {
                console.error('WebSocket connection closed unexpectedly: ', e);
                // Reinitialize WebSocket if it's not in CLOSED state
                if (chatSocket.readyState !== WebSocket.CLOSED) {
                    console.log('Reconnecting WebSocket...');
                    setTimeout(initWebSocket, 1000); // Retry after 1 second
                }
            };

            chatSocket.onerror = function(e) {
                console.error('WebSocket error occurred: ', e);
                // Close WebSocket connection on error
                chatSocket.close();
            };

            // Function to send message
            function sendMessage() {
                const messageInputDom = document.getElementById('chat-message-input');
                const message = messageInputDom.value;
                chatSocket.send(JSON.stringify({ // object to sting conversion with stringify methos of json
                    'message': message
                }));
                messageInputDom.value = '';
            }

            // Event listener for message submit button
            document.querySelector('#chat-message-submit').onclick = sendMessage;

            // Event listener for enter key to send message
            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {  // Enter key
                    sendMessage();
                }
            };
        }

        // Initialize WebSocket when the page loads
        window.onload = function() {
            initWebSocket();
        };
    </script>
</body>
</html>
